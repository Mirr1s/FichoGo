{% extends 'core/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-primary">Bienvenido, {{ user.get_full_name|default:user.username }}!</h2>
  <p class="text-muted">Has iniciado sesión correctamente.</p>

  {% if es_admin %}
    <a href="{% url 'validar_ficho_admin' %}" class="btn btn-success mb-3">
      <i class="bi bi-check-circle"></i> Ir a Validar Fichos
    </a>
    <hr>
    {% include 'core/panel_admin.html' %}
  {% else %}
    <a href="{% url 'solicitar_ficho' %}" class="btn btn-primary mb-3">
      <i class="bi bi-plus-circle"></i> Solicitar Ficho
    </a>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title text-success">Información del Usuario</h5>
        <p><strong>Usuario:</strong> {{ user.first_name }} &nbsp; <strong>Código:</strong> {{ user.username }}</p>
      </div>
    </div>

    {% if ficho_existente %}
      <div class="alert alert-info">
        <h5><i class="bi bi-info-circle"></i> Ficho Activo para Hoy</h5>
        <p><strong>Servicio:</strong> {{ ficho_existente.cupo.nombre_servicio }}</p>
        <p><strong>Hora:</strong> {{ ficho_existente.hora }}</p>
        <p><strong>Estado:</strong> {{ ficho_existente.estado }}</p>
        {% if ficho_existente.qr %}
          <div class="text-center">
            <img src="{{ ficho_existente.qr.url }}" alt="QR del ficho" class="img-fluid" style="max-width:200px;">
          </div>
        {% endif %}
        <form action="{% url 'cancelar_ficho' ficho_existente.id %}" method="get" class="mt-3">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle"></i> Cancelar Ficho
          </button>
        </form>
      </div>
    {% endif %}

    {% if historial_fichos %}
      <hr>
      <h4 class="text-primary">Historial de Fichos</h4>
      <table class="table table-striped table-hover table-responsive">
        <thead class="table-primary">
          <tr>
            <th>Fecha</th>
            <th>Servicio</th>
            <th>Hora</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for ficho in historial_fichos %}
          <tr>
            <td>{{ ficho.cupo.fecha }}</td>
            <td>{{ ficho.cupo.nombre_servicio }}</td>
            <td>{{ ficho.hora }}</td>
            <td>{{ ficho.estado|title }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center">Sin fichos previos</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    <hr>
    <h4 class="text-primary">Últimos 3 Fichos</h4>
    <div class="row">
      {% for ficho in ultimos_fichos %}
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">{{ ficho.cupo.nombre_servicio }}</h5>
            <p><strong>Hora:</strong> {{ ficho.hora }}</p>
            <p><strong>Estado:</strong> {{ ficho.estado }}</p>
            <p><strong>Fecha:</strong> {{ ficho.fecha_creacion|date:"d/m/Y H:i" }}</p>
            {% if ficho.codigo_qr %}
              <img src="{{ ficho.codigo_qr.url }}" alt="QR" class="img-fluid" style="max-width:100px;">
            {% else %}
              <p class="text-muted">QR no disponible</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-center">No tienes fichos recientes.</p>
      {% endfor %}
    </div>
  {% endif %}

  <form action="{% url 'logout' %}" method="post" class="mt-4">
    {% csrf_token %}
    <button type="submit" class="btn btn-secondary">
      <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
    </button>
  </form>
</div>
{% endblock %}
