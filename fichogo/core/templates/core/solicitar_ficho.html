{% extends 'core/base.html' %}
{% block content %}
<h2>Solicitar Ficho</h2>
<!-- Mostrar horarios de los servicios -->
<div class="alert alert-info" style="margin-bottom: 20px;">
    <strong>Horarios de los servicios:</strong>
    <ul>
        <li>Desayuno: 06:45 AM a 08:30 AM</li>
        <li>Almuerzo: 11:30 AM a 01:30 PM</li>
        <li>Cena: 05:30 PM a 07:30 PM</li>
    </ul>
</div>
{% if mensaje_bloqueo %}
    <div class="alert alert-success" role="alert" style="margin-bottom: 20px;">{{ mensaje_bloqueo }}</div>
{% elif ficho_existente %}
    <hr>
    <h2>Ficho generado exitosamente</h2>
    <p><strong>Servicio:</strong> {{ ficho_existente.cupo.nombre_servicio }}</p>
    <p><strong>Fecha:</strong> {{ ficho_existente.cupo.fecha|date:'d \\d\\e F \\d\\e Y' }}</p>
    <p><strong>Hora de asistencia:</strong> {{ ficho_existente.hora }}</p>
    <p><strong>Estado:</strong> {{ ficho_existente.estado }}</p>
    <p><strong>Código QR:</strong></p>
    <img src="/{{ ficho_existente.codigo_qr }}" alt="Código QR del ficho" style="width:200px;">        <p><strong>Número de personas por delante de ti:</strong> {{ fichos_adelante }}</p>
{% else %}
<form method="post">
    {% csrf_token %}
    <label for="cupo_id">Servicio:</label>
    <select name="cupo_id" id="cupo_id" required onchange="actualizarHorario()">
        {% for servicio in servicios %}
            <option value="{{ servicio.id }}" data-servicio="{{ servicio.nombre_servicio }}">{{ servicio.nombre_servicio }} (Disponibles: {{ servicio.cantidad_disponible }})</option>
        {% endfor %}
    </select>
    <div id="horario-servicio" style="margin: 10px 0; font-weight: bold;"></div>
    <label for="hora">Hora de asistencia:</label>
    <input type="time" name="hora" id="hora" required>
    <small>Formato: 12 horas (AM/PM)</small>
    <button type="submit">Solicitar</button>
</form>

<!-- Mostrar servicios activos del usuario -->
{% with fichos_activos=historial_fichos_activos %}
{% if fichos_activos %}
    <div class="alert alert-success mt-3">
        <strong>Servicios activos hoy:</strong>
        <ul>
        {% for ficho in fichos_activos %}
            <li>{{ ficho.cupo.get_nombre_servicio_display }} - {{ ficho.hora }} (<a href="{% url 'ver_ficho' ficho.id %}">ver</a>)</li>
        {% endfor %}
        </ul>
    </div>
{% endif %}
{% endwith %}
<script>
    const horarios = JSON.parse('{{ horarios_servicio|safe|escapejs }}');
    function actualizarHorario() {
        const select = document.getElementById('cupo_id');
        const selected = select.options[select.selectedIndex];
        const servicio = selected.getAttribute('data-servicio');
        const horario = horarios[servicio];
        if (horario) {
            document.getElementById('horario-servicio').innerText = `Horario: ${horario.inicio} a ${horario.fin}`;
            // Ya no se fuerza min/max en el input, solo se muestra el horario permitido
            document.getElementById('hora').removeAttribute('min');
            document.getElementById('hora').removeAttribute('max');
        } else {
            document.getElementById('horario-servicio').innerText = '';
            document.getElementById('hora').removeAttribute('min');
            document.getElementById('hora').removeAttribute('max');
        }
    }
    document.addEventListener('DOMContentLoaded', actualizarHorario);
    document.getElementById('cupo_id').addEventListener('change', actualizarHorario);
    document.getElementById('hora').setAttribute('lang', 'es-MX');
</script>
{% endif %}
{% if messages %}
    <ul>
    {% for message in messages %}
        <li>{{ message }}</li>
    {% endfor %}
    </ul>
{% endif %}
{% endblock %}
